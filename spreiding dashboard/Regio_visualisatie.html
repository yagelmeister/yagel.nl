<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Opleidingen per regio</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      margin: 0;
    }
    #controls {
      width: 320px;
      padding: 20px;
      background: #f9f9f9;
      border-right: 1px solid #ddd;
    }

    .section-instellingen {
      margin-bottom: 1.5rem;
    }

    .filter-row {
      display: flex;
      gap: 1rem;            /* ruimte tussen de twee boxen */
    }

    .filter-col {
      flex: 1;              /* allebei even breed */
    }

    #map {
      margin-top: 1rem;
      flex-grow: 1;
    }

    h3 {
      font-size: 1rem;
      margin: 0 0 0.5rem 0;
      color: #003366;
    }

    select, button, input[type="text"] {
      width: 100%;
      margin-bottom: 0.75rem;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      font-size: 0.9rem;
    }

   #zoekCategorieBtn {
      cursor: pointer;
      background: #f0f8ff;
      border: 1px solid #99c;
      border-radius: 6px;
      margin-top: 20px;
      padding: 8px 12px;
      font-weight: 500;
      transition: background 0.2s, box-shadow 0.2s;
    }
    #zoekCategorieBtn:hover {
      background: #e0f0ff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .section {
      margin-bottom: 1.5rem;
    }

    .switch-row {
      display: flex;
      align-items: center;
      justify-content: space-between; /* verdeelt netjes */
      margin-bottom: 0.75rem;
    }

    .switch-row .toggle-label {
      flex: 1;              /* links en rechts krijgen gelijke ruimte */
      text-align: center;   /* tekst centreren */
      margin: 0;            /* margin weghalen */
      min-width: 0;         /* geen vaste breedte forceren */
    }

    .switch {
      flex: 0 0 46px;       /* switch blijft vaste breedte */
    }

    .switch-row label {
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }

    .toggle-label {
      font-size: 0.85rem;
      margin: 0 0.5rem;
      min-width: 80px; /* zodat het netjes uitlijnt */
      text-align: center;
    }


    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 22px;
    }
    .switch input { display: none; }
    .slider {
      position: absolute; cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .3s;
      border-radius: 22px;
    }
    .slider:before {
      position: absolute; content: "";
      height: 16px; width: 16px; left: 3px; bottom: 3px;
      background-color: white; transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider { background-color: #585858; }
    input:checked + .slider:before { transform: translateX(24px); }

    .tooltip {
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    svg {
      width: 80%;
      height: 550px;
    }
    .label {
      font-size: 12px;
      text-anchor: middle;
      pointer-events: none;
    }

    .hint {
      font-size: 0.9rem;
      margin-bottom: 1rem;
      padding: 0.1rem;
      border-radius: 6px;
    }

    .infotip {
      position: relative;     /* basispositie voor de tekst */
      cursor: help;
      display: inline-block;
      z-index: 10000;
    }
    
    .infotip-text {
      position: absolute;
      top: 125%;
      left: 50%;

      visibility: hidden;
      opacity: 0;

      max-width: 90vw;          /* nooit breder dan viewport */
      width: 260px;
      padding: 0.75rem;

      background-color: #184731;
      color: white;
      text-align: left;
      border-radius: 8px;

      white-space: normal;
      overflow-wrap: break-word;

      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 100001;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);

      font-size: 0.85rem;
      line-height: 1.2;
      font-weight: 300;
    }


    .infotip:hover .infotip-text {
      visibility: visible;
      opacity: 1;
    }



    .multi-dropdown {
      position: relative;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
    }

    .multi-dropdown-label {
      padding: 6px 8px;
    }

    .multi-dropdown-panel {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 100;
      display: none;
      padding: 4px 6px;
    }

    .multi-dropdown.open .multi-dropdown-panel {
      display: block;
    }

    .multi-dropdown-option {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 2px 2px;
      font-size: 0.85rem;
    }

    .multi-dropdown-option input {
      flex: 0 0 auto;
    }

    .multi-dropdown-option span {
      flex: 1 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .button-row-instellingen {
      display: flex;
      gap: 4px;          /* ruimte tussen de knoppen */
      margin-top: 6px;
    }

    .button-instellingen {
      font-size: 0.65rem;
      padding: 2px 6px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background: #f2f2f2;
      cursor: pointer;
      white-space: nowrap; 
    }

    .button-instellingen:hover {
      background: #e6e6e6;
    }
  </style>
</head>

<body>
  <div id="controls">

    <!-- Categorie selectie -->
    <div class="section">
      <h3>
        Kies een NIDAP hoofd- of subcategorie
        <span class="infotip">&#9432;
          <span class="infotip-text">
            NIDAP heeft alle HBO- en WO-opleidingen in Nederland ingedeeld naar een eigen categorisering.
          </span>
        </span>
      </h3>

      <div class="switch-row">
        <span class="toggle-label">Hoofdcategorie</span>
        <label class="switch">
          <input type="checkbox" id="catToggle">
          <span class="slider"></span>
        </label>
        <span class="toggle-label">Subcategorie</span>
      </div>

      <label id="catSelectLabel"></label>
      <select id="catSelect"></select>

        
        <button id="zoekCategorieBtn">Binnen welke categorie valt uw opleiding?</button>
    </div>

    <!-- Instellingen -->
    <div class="section-instellingen">
      <h3>Kies welke instellingen u wilt meenemen</h3>
  
      <div id="instellingDropdown" class="multi-dropdown">
        <div id="instellingDropdownLabel" class="multi-dropdown-label">
          Alle instellingen
        </div>
        <div id="instellingDropdownPanel" class="multi-dropdown-panel">
          <!-- hier komen de checkbox-opties via JS -->
        </div>
      </div>

      <div class="button-row-instellingen">
        <button id="instellingSelectAllBtn" type="button" class="button-instellingen">
          Selecteer alle instellingen
        </button>
        <button id="instellingClearBtn" type="button" class="button-instellingen">
          Deselecteer alle instellingen
        </button>
      </div>    </div>

    <!-- Opleidingsvorm -->
    <div class="section filter-row">
      <div class="filter-col" id="vormCheckboxes">
        <h3>Opleidingsvorm</h3>
        <label><input type="checkbox" value="voltijd onderwijs" checked> Voltijd</label><br>
        <label><input type="checkbox" value="deeltijd onderwijs"> Deeltijd</label><br>
        <label><input type="checkbox" value="duaal onderwijs"> Duaal</label>
      </div>

    <!-- Type hoger onderwijs -->
      <div class="filter-col" id="typeOnderwijsCheckboxes">
        <h3>Type hoger onderwijs</h3>
        <label><input type="checkbox" value="associate degree" checked> Associate Degree</label><br>
        <label><input type="checkbox" value="bachelor" checked> Bachelor</label><br>
        <label><input type="checkbox" value="master" checked> Master</label>
        <!-- <label><input type="checkbox" value="postmaster" checked> Post-master</label>
        <label><input type="checkbox" value="ongedeelde opleiding" checked> Ongedeelde opleiding</label> -->
      </div>
    </div>

    <!-- Toggles -->
    <div class="section">
      <h3>Opleidingsniveau</h3>
      <div class="switch-row">
        <span class="toggle-label">HBO</span>
        <label class="switch">
          <input type="checkbox" id="niveauToggle" checked>
          <span class="slider"></span>
        </label>
        <span class="toggle-label">WO</span>
      </div>

      <h3>Welke regio-indeling wilt u gebruiken?</h5>
      <div class="switch-row">
        <span class="toggle-label">Provincie</span>
        <label class="switch">
          <input type="checkbox" id="geoToggle">
          <span class="slider"></span>
        </label>
        <span class="toggle-label">Arbeidsmarktregio</span>
      </div>

      <h3>Wat wilt u gevisualiseerd zien?</h3>
      <div class="switch-row">
        <span class="toggle-label">Aantal opleidingen</span>
        <label class="switch">
          <input type="checkbox" id="dataToggle">
          <span class="slider"></span>
        </label>
        <span class="toggle-label">Instroom</span>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <!-- Popup overlay en venster -->
  <div id="popupOverlay" 
      style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
             background:rgba(0,0,0,0.3); z-index:999;"></div>

  <div id="zoekCategoriePopup" 
      style="display:none; position:fixed; top:15%; left:25%; width:50%; 
             background:#fff; border:1px solid #ccc; border-radius:8px; padding:1rem; 
             box-shadow:0 2px 10px rgba(0,0,0,0.25); z-index:1000;">
    <h3>Categorie opzoeken</h3>
    <label>Instelling:</label>
    <input type="text" id="zoekInstellingInput" placeholder="Typ instellingsnaam...">
    <div id="instellingSuggesties" style="border:1px solid #ccc; max-height:150px; overflow-y:auto; display:none;"></div>

    <label>Opleiding:</label>
    <input type="text" id="zoekOpleidingInput" placeholder="Typ opleidingsnaam..." disabled>
    <div id="opleidingSuggesties" style="border:1px solid #ccc; max-height:150px; overflow-y:auto; display:none;"></div>

    <div id="zoekCategorieResultaat" style="margin-top:1rem; display:none;">
      <strong>Categorie:</strong>
      <div id="zoekCategorieLink" 
           style="margin-top:0.5rem; cursor:pointer; padding:0.5rem; border:1px solid #ccc; border-radius:6px; background:#f9f9f9;">
      </div>
    </div>

    <button id="sluitPopupBtn" style="margin-top:1rem;">Sluiten</button>
  </div>
</body>

<script>
    let colorScale = d3.scaleLinear()
      .domain([0, 10])
      .range(["#d73027", "#1a9850"]);
    let data;
    let provincesGeo, arbeidsmarktGeo;
    let svg;
    let tooltip;
    let projection, path; 
    let currentGeo = "provincie"; 
    let useInstroom = false; 
    let precomputedPositions = {};

    d3.json("posities_tekst_regios.json").then(json => {
      precomputedPositions = json;
    });

    d3.json("resultaten_gemeente.json").then((jsonData) => {
      data = jsonData.map(d => ({
        ...d,
        "Provincie": d["Provincie"],
        "Arbeidsmarktregio": d["Arbeidsmarktregio"],
        "Niveau": d["Niveau"],
        "Subcategorie - NIDAP": d["Subcategorie - NIDAP"],
        "Hoofdcategorie - NIDAP": d["Hoofdcategorie - NIDAP"],
        "OPLEIDINGSVORM": d["OPLEIDINGSVORM"]
      }));

      populateCategorySelect("Hoofdcategorie - NIDAP");

      d3.select("#niveauToggle").on("change", function() {
        d3.select("#niveauLabel").text(this.checked ? "WO" : "HBO");
        populateInstellingenFilter();   // lijst instellingen opnieuw opbouwen
        updateMap();
      });
      d3.selectAll("#vormCheckboxes input").on("change", updateMap);
      d3.selectAll("#typeOnderwijsCheckboxes input").on("change", updateMap);

      d3.select("#catToggle").on("change", function() {
        const isChecked = this.checked;
        const catType = isChecked ? "Subcategorie - NIDAP" : "Hoofdcategorie - NIDAP";
        d3.select("#catLabel").text(isChecked ? "Subcategorie" : "Hoofdcategorie");
        populateCategorySelect(catType);

        // map resetten
        d3.selectAll(".regions path").attr("fill", "#eee");
        if (svg) svg.selectAll(".labels").remove();

        // instellingenlijst ook weer in lijn brengen met nieuwe catType
        populateInstellingenFilter();
      });

      d3.select("#catSelect").on("change", function() {
        populateInstellingenFilter();   // instellingen die binnen deze categorie vallen
        updateMap();
      });

      d3.select("#geoToggle").on("change", function() {
        currentGeo = this.checked ? "arbeidsmarktregio" : "provincie";
        d3.select("#geoLabel").text(this.checked ? "Arbeidsmarktregio" : "Provincie");
        drawMap();
        updateMap();
      });

      d3.select("#dataToggle").on("change", function() {
        useInstroom = this.checked;
        d3.select("#dataLabel").text(useInstroom ? "Instroom (Gem. 2023 - 2024)" : "Aantal opleidingen");
        updateMap();
      });

      const popup = document.getElementById("zoekCategoriePopup");
      const overlay = document.getElementById("popupOverlay");
    
      // Open/close popup
      d3.select("#zoekCategorieBtn").on("click", () => {
        overlay.style.display = "block";
        popup.style.display = "block";
      });

      // Sluiten via knop
      d3.select("#sluitPopupBtn").on("click", () => {
        overlay.style.display = "none";
        popup.style.display = "none";
      });

      // Sluiten via overlay klik
      overlay.addEventListener("click", () => {
        overlay.style.display = "none";
        popup.style.display = "none";
      });


      const instInput = document.getElementById("zoekInstellingInput");
      const instSuggesties = document.getElementById("instellingSuggesties");
      const oplInput = document.getElementById("zoekOpleidingInput");
      const oplSuggesties = document.getElementById("opleidingSuggesties");

      let gekozenInstelling = null;
      let gekozenOpleiding = null;

      // Functie om suggesties te tonen
      function toonSuggesties(inputElem, suggDiv, lijst, callback) {
        const q = inputElem.value.toLowerCase();
        suggDiv.innerHTML = "";
        if (!q) { suggDiv.style.display="none"; return; }
        const matches = lijst.filter(v => v.toLowerCase().includes(q)).slice(0,20);
        if (matches.length === 0) { suggDiv.style.display="none"; return; }
        matches.forEach(m => {
          const div = document.createElement("div");
          div.textContent = m;
          div.style.padding = "4px 6px";
          div.style.cursor = "pointer";
          div.addEventListener("click", () => {
            inputElem.value = m;
            suggDiv.style.display = "none";
            callback(m);
          });
          suggDiv.appendChild(div);
        });
        suggDiv.style.display = "block";
      }

      // Instelling input
      instInput.addEventListener("input", () => {
        const instellingen = Array.from(new Set(data.map(d => d["INSTELLINGSNAAM ACTUEEL"]))).sort();
        toonSuggesties(instInput, instSuggesties, instellingen, (keuze) => {
          gekozenInstelling = keuze;
          oplInput.disabled = false;
          oplInput.value = "";
          document.getElementById("zoekCategorieResultaat").style.display = "none";
        });
      });

      // Opleiding input (afhankelijk van gekozen instelling)
      oplInput.addEventListener("input", () => {
        if (!gekozenInstelling) return;
        const opleidingen = Array.from(new Set(
          data.filter(d => d["INSTELLINGSNAAM ACTUEEL"] === gekozenInstelling)
              .map(d => d["OPLEIDINGSNAAM ACTUEEL"])
        )).sort();
        toonSuggesties(oplInput, oplSuggesties, opleidingen, (keuze) => {
          gekozenOpleiding = keuze;
          toonCategorie();
        });
      });

      function toonCategorie() {
        const mogelijkeMatches = data.filter(d =>
          d["INSTELLINGSNAAM ACTUEEL"] === gekozenInstelling &&
          d["OPLEIDINGSNAAM ACTUEEL"].toLowerCase().includes(gekozenOpleiding.toLowerCase())
        );
        if (!gekozenInstelling || !gekozenOpleiding) return;
        const match = data.find(d => 
          d["INSTELLINGSNAAM ACTUEEL"].toLowerCase().trim() === gekozenInstelling.toLowerCase().trim() &&
          d["OPLEIDINGSNAAM ACTUEEL"].toLowerCase().trim() === gekozenOpleiding.toLowerCase().trim()
        );
        if (match) {
          const gebruikHoofd = d3.select("#catToggle").property("checked");
          const catType = gebruikHoofd ? "Subcategorie - NIDAP" : "Hoofdcategorie - NIDAP";
          const cat = match[catType] || "(geen categorie gevonden)";

          d3.select("#zoekCategorieResultaat").style("display","block");
          d3.select("#zoekCategorieLink").html(`
            <label style="display:flex;align-items:center;gap:0.4rem;font-size:0.85rem;">
              <input type="checkbox" id="zoekCategorieCheckbox" value="${cat}">
              ${cat}
            </label>
          `);

          const checkbox = document.getElementById('zoekCategorieCheckbox');
          const catOption = [...document.querySelectorAll('#catSelect option')].find(opt => opt.value === cat);

          if (catOption) {
            checkbox.checked = (catOption.selected);
          }

          checkbox.addEventListener('change', () => {
            if (catOption) {
              catOption.selected = checkbox.checked;
              document.getElementById("catSelect").dispatchEvent(new Event("change"));
            }
          });
        }
      }

      // Instellingen dropdown vullen (afhankelijk van niveau + categorie)
      function populateInstellingenFilter() {
        const panel = d3.select("#instellingDropdownPanel");
        panel.selectAll("*").remove();

        // huidig niveau
        const niveau = d3.select("#niveauToggle").property("checked") ? "wo" : "hbo";

        // huidig categorietype + gekozen categorie
        const gebruikSub = d3.select("#catToggle").property("checked");
        const catType = gebruikSub ? "Subcategorie - NIDAP" : "Hoofdcategorie - NIDAP";
        const catValue = d3.select("#catSelect").property("value");

        // basisfilter: juiste niveau
        let subset = data.filter(d =>
          d.Niveau &&
          d.Niveau.toLowerCase() === niveau
        );

        // als er een categorie gekozen is: daarop inzoomen
        if (catValue) {
          subset = subset.filter(d => d[catType] === catValue);
        }

        const instellingen = Array.from(
          new Set(subset.map(d => d["INSTELLINGSNAAM ACTUEEL"]))
        ).sort();

        instellingen.forEach(inst => {
          const label = panel.append("label")
            .attr("class", "multi-dropdown-option");

          label.append("input")
            .attr("type", "checkbox")
            .attr("value", inst)
            .on("change", () => {
              updateInstellingLabel();
              updateMap();
            });

          label.append("span").text(inst);
        });

        updateInstellingLabel();
      }


      function updateInstellingLabel() {
        const allOptions = d3.selectAll("#instellingDropdownPanel input");
        const checked = d3.selectAll("#instellingDropdownPanel input:checked");
        const label = d3.select("#instellingDropdownLabel");

        const total = allOptions.size();
        const selected = checked.size();

        if (selected === 0 || selected === total || total === 0) {
          label.text("Alle instellingen");
        } else if (selected === 1) {
          label.text(checked.nodes()[0].value);
        } else {
          label.text(selected + " instellingen geselecteerd");
        }
      }

      function setInstellingenChecked(checked) {
        d3.selectAll("#instellingDropdownPanel input[type='checkbox']")
          .property("checked", checked);

        updateInstellingLabel();
        updateMap();
      }

      const selectAllBtn = document.getElementById("instellingSelectAllBtn");
      const clearBtn = document.getElementById("instellingClearBtn");

      if (selectAllBtn) {
        selectAllBtn.addEventListener("click", (e) => {
          e.preventDefault();
          setInstellingenChecked(true);
        });
      }

      if (clearBtn) {
        clearBtn.addEventListener("click", (e) => {
          e.preventDefault();
          setInstellingenChecked(false);
        });
      }


      // dropdown open/dicht klappen
      (function initInstellingDropdown() {
        const dropdown = document.getElementById("instellingDropdown");
        const panel = document.getElementById("instellingDropdownPanel");
        const labelEl = document.getElementById("instellingDropdownLabel");

        if (!dropdown || !panel || !labelEl) return;

        // Alleen het label klapt de dropdown open/dicht
        labelEl.addEventListener("click", (e) => {
          e.stopPropagation(); // voorkom dat het meteen doorbubbelt naar document-click
          dropdown.classList.toggle("open");
        });

        // Klikken in het panel (checkboxen, teksten) sluit NIET
        panel.addEventListener("click", (e) => {
          e.stopPropagation();
        });

        // Sluiten als je buiten de dropdown klikt
        document.addEventListener("click", (e) => {
          if (!dropdown.contains(e.target)) {
            dropdown.classList.remove("open");
          }
        });
      })();

      // initialiseren nadat data is gezet
      populateInstellingenFilter();

      Promise.all([
        d3.json("https://cartomap.github.io/nl/wgs84/provincie_2022.topojson"),
        d3.json("arbeidsmarktregios.geojson")
      ]).then(([topoData, arbeidsmarkt]) => {
        provincesGeo = topojson.feature(topoData, topoData.objects.provincie_2022);
        arbeidsmarktGeo = arbeidsmarkt;
        drawMap();
      });
    });

    function populateCategorySelect(catType) {
      const select = d3.select("#catSelect");
      select.selectAll("option").remove();
      select.append("option").text("-- kies " + catType.split(" ")[0].toLowerCase() + " --").attr("value", "");
      const values = Array.from(new Set(data.map(d => d[catType]))).sort();
      values.forEach(v => select.append("option").text(v).attr("value", v));
    }

    function drawMap() {
      if (svg) svg.remove();
      svg = d3.select("#map").append("svg");
      const geo = currentGeo === "provincie" ? provincesGeo : arbeidsmarktGeo;
      projection = d3.geoMercator().fitSize([500, 500], geo); 
      path = d3.geoPath().projection(projection); 

      // Tooltip div toevoegen (één keer bij laden)
      tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("background", "white")
        .style("border", "1px solid #ccc")
        .style("border-radius", "4px")
        .style("padding", "6px 10px")
        .style("pointer-events", "none")
        .style("font-size", "12px")
        .style("display", "none");

      svg.append("g")
        .attr("class", "regions")
        .selectAll("path")
        .data(geo.features)
        .enter().append("path")
        .attr("d", path)
        .attr("stroke", "#333")
        .attr("fill", "#eee")
        .attr("id", d => d.properties.statnaam || d.properties.Naam || d.properties.arbeidsmarktregio);
    }

    function drawColorbar(minVal, maxVal) {
      svg.selectAll(".colorbar").remove();
      svg.selectAll("defs #linear-gradient-vertical").remove();

      const mapHeight = +svg.attr("height") || svg.node().getBoundingClientRect().height;
      const legendWidth = 15;
      const legendHeight = mapHeight * 0.3;

      const defs = svg.append("defs");
      const gradient = defs.append("linearGradient")
        .attr("id", "linear-gradient-vertical")
        .attr("x1", "0%").attr("y1", "100%")
        .attr("x2", "0%").attr("y2", "0%");

      const steps = 50;
      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const val = minVal + t * (maxVal - minVal);
        gradient.append("stop")
          .attr("offset", `${t * 100}%`)
          .attr("stop-color", colorScale(val));
      }

      const legendGroup = svg.append("g")
        .attr("class", "colorbar")
        .attr("transform", `translate(600,100)`);

      legendGroup.append("rect")
        .attr("width", legendWidth)
        .attr("height", legendHeight)
        .style("fill", "url(#linear-gradient-vertical)")
        .style("stroke", "#333");

      const legendScale = d3.scaleLinear()
        .domain([minVal, maxVal])
        .range([legendHeight, 0]);

      const legendAxis = d3.axisRight(legendScale)
        .ticks(4)
        .tickFormat(d3.format("d"));

      legendGroup.append("g")
        .attr("class", "axis")
        .attr("transform", `translate(${legendWidth},0)`)
        .call(legendAxis);

      legendGroup.append("text")
        .attr("class", "colorbar-title")
        .attr("x", legendWidth / 2)
        .attr("y", -10)
        .attr("text-anchor", "middle")
        .style("font-size", "12px")
        .style("font-weight", "bold")
        .text(useInstroom ? "Instroom (Gem. 2023 - 2024)" : "Aantal opleidingen");
    }

    function updateMap() {
      const niveau = d3.select("#niveauToggle").property("checked") ? "wo" : "hbo";
      const catType = d3.select("#catToggle").property("checked") ? "Subcategorie - NIDAP" : "Hoofdcategorie - NIDAP";
      const catValue = d3.select("#catSelect").property("value");

      const selectedVormen = [];
      d3.selectAll("#vormCheckboxes input:checked").each(function() {
        selectedVormen.push(this.value.toLowerCase());
      });

      const selectedTypes = [];
      d3.selectAll("#typeOnderwijsCheckboxes input:checked").each(function() {
        selectedTypes.push(this.value.toLowerCase());
      });

      const selectedInstellingen = [];
      d3.selectAll("#instellingDropdownPanel input:checked").each(function() {
        selectedInstellingen.push(this.value);
      });
      const hasInstellingFilter = selectedInstellingen.length > 0;

      if (!catValue) return;

      let filtered = data.filter(d =>
        d.Niveau.toLowerCase() === niveau &&
        d[catType] === catValue &&
        selectedVormen.includes(d["OPLEIDINGSVORM"].toLowerCase()) &&
        selectedTypes.includes(d["TYPE HOGER ONDERWIJS"].toLowerCase())
      );

      if (hasInstellingFilter) {
        filtered = filtered.filter(d =>
          selectedInstellingen.includes(d["INSTELLINGSNAAM ACTUEEL"])
        );
      }
      
      const groupKey = currentGeo === "provincie" ? "Provincie" : "Arbeidsmarktregio";
      useInstroom = d3.select("#dataToggle").property("checked");

      const counts = d3.rollup(
        filtered,
        v => useInstroom 
              ? Math.round(d3.sum(v, d => +d["Gem. 2023 - 2024"] || 0)) 
              : v.length,
        d => d[groupKey]
      );

      let minVal = 0;
      let maxVal = d3.max(counts.values());

      if (!isFinite(maxVal) || isNaN(maxVal)) {
        // nothing to show, fallback
        minVal = 0;
        maxVal = 5;
      } else {
        minVal = Math.floor(minVal / 5) * 5;
        maxVal = Math.ceil(maxVal / 5) * 5;
        if (minVal === maxVal) {
          minVal = 0;
          maxVal += 5;
        }
      }

      colorScale = d3.scaleLinear()
        .domain([minVal, maxVal])
        .range(["#fee5d9", "#7f0000"]);

      const geo = currentGeo === "provincie" ? provincesGeo : arbeidsmarktGeo;
      d3.selectAll(".regions path")
        .transition().duration(500)
        .attr("fill", d => {
          const naam = d.properties.statnaam || d.properties.Naam || d.properties.Regio;
          const count = counts.get(naam) || 0;
          return colorScale(count);
        });

      // In updateMap(), na .attr("fill", ...)
      d3.selectAll(".regions path")
        .on("mouseover", function (event, d) {
        const naam = d.properties.statnaam || d.properties.Naam || d.properties.Regio;

        // zelfde filtering als bij counts
        const niveau = d3.select("#niveauToggle").property("checked") ? "wo" : "hbo";
        const catType = d3.select("#catToggle").property("checked")
          ? "Subcategorie - NIDAP"
          : "Hoofdcategorie - NIDAP";
        const catValue = d3.select("#catSelect").property("value");
        const selectedVormen = [];
        d3.selectAll("#vormCheckboxes input:checked").each(function() {
          selectedVormen.push(this.value.toLowerCase());
        });

        const filtered = data.filter(d =>
          d.Niveau.toLowerCase() === niveau &&
          d[catType] === catValue &&
          selectedVormen.includes(d["OPLEIDINGSVORM"].toLowerCase()) &&
          selectedTypes.includes(d["TYPE HOGER ONDERWIJS"].toLowerCase())
        );

        const regioRecords = filtered.filter(x =>
          (currentGeo === "provincie" ? x.Provincie : x.Arbeidsmarktregio) === naam
        );

        const aantalOpleidingen = regioRecords.length;
        const instroom = d3.sum(regioRecords, x => +x["Gem. 2023 - 2024"] || 0);

        // gewogen gemiddelde trend naar instroom
        const totaalInstroom = instroom;
        const trend = totaalInstroom > 0
          ? d3.sum(regioRecords, x =>
              (+x["Trend 2018 - 2024"] || 0) * (+x["Gem. 2023 - 2024"] || 0)
            ) / totaalInstroom
          : 0;

        tooltip.style("display", "block")
          .html(`
            <strong>${naam}</strong><br>
            Aantal opleidingen: ${aantalOpleidingen}<br>
            Instroom: ${instroom}<br>
            Instroomtrend: ${d3.format("+.1f")(trend)}%
          `);
      })
      .on("mousemove", function (event) {
          tooltip.style("left", (event.pageX + 12) + "px")
                .style("top", (event.pageY - 28) + "px");
        })
        .on("mouseout", function () {
          tooltip.style("display", "none");
        });

      function getLabelPosition(d) {
        const naam = d.properties.statnaam || d.properties.Naam || d.properties.Regio;
        const info = precomputedPositions[naam];
        if (info && info.coords) {
          return info.coords;         // opgeslagen [x, y] schermcoördinaten
        }
        // fallback: centroid als er niks in JSON staat
        return path.centroid(d);
      }


      svg.selectAll(".labels").remove();
      const textLayer = svg.append("g").attr("class", "labels");
      textLayer.selectAll("text")
        .data(geo.features)
        .enter().append("text")
        .attr("class", "label")
        .attr("x", d => getLabelPosition(d)[0])
        .attr("y", d => getLabelPosition(d)[1])
        .style("font-size", "14px")
        .style("font-weight", "500")
        .style("font-color", 'dark-green')
        .attr("fill", d => {
          // const naam = d.properties.statnaam || d.properties.Naam || d.properties.Regio;
          // const count = counts.get(naam) || 0;
          // const col = d3.color(colorScale(count));
          // if (!col) {
          //   return "#000";
          // }  // fallback
          // // bereken luminantie → threshold ca. 0.5
          // const luminance = (0.299*col.r + 0.587*col.g + 0.114*col.b) / 255;
          // return luminance < 0.5 ? "#fff" : "#000";
          return "#000"
        })
        .text(d => {
          const naam = d.properties.statnaam || d.properties.Naam || d.properties.Regio;
          return counts.get(naam) || 0;
        });

      drawColorbar(minVal, maxVal);
    }
  </script>
</html>